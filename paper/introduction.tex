\section{Introduction}
\label{introduction}

Medical devices like implantable pacemakers are designed to diagnose and improve undesired physiological conditions. The capability to affect the physiological conditions of the patient makes the safety of the devices an essential consideration. 
The software component of these devices is getting increasingly complex, inevitably leading to more safety violations.
For example, implantable cardiac pacemakers have over 80,000 lines of code which are responsible for maintaining the heart within safe operating limits. As firmware-related recalls accounted for over 41\% of the 600,000 devices recalled in the last decade, there is a need for rigorous evaluation of device software~\cite{recalls}. 
%From 1996-2006, the percentage of software-related causes in medical device recalls has grown from 10\% to 21\%. 
%For example, during the first half of 2010, the US Food and Drug Administration (FDA) issued 23 recalls of defective devices, all of which can cause serious adverse health consequences or death. At least six of these recalls were caused by software defects~\cite{killedbycode}. 
Consequently, in this paper we focus on the closed-loop testing of cardiac pacemakers and their software in the context of a heart model, although the proposed methods are more broadly applicable.

To ensure the safety and efficacy of pacemaker software, we first need to ensure that it exhibits the desired input-output relationship, which is captured in the \emph{Software Specifications} (e.g. the pacemaker should not pace faster than the upper rate limit). 
We also have to ensure that the software is capable of improving the physiological conditions as designed, which is captured in the \emph{Physiological Requirements} (e.g. the atrial and ventricle rates should be matched during sinus bradycardia). 
%The procedure for checking that the software satisfies these two design documents is referred to as \emph{Verification}. 
While the US FDA requires device manufacturers to submit \emph{sufficient evidence} regarding the safety and efficacy of the devices before they can be released to the market, they do not test their code or specify quantitative approaches for software verification and testing. 
Currently, the conformance of the device to its specifications is verified using \emph{open-loop testing} in which the device is given input signals and its output signals are compared with desired outputs according to the Specifications. 
The input signals are generated by an engineer, or from recorded traces of previous devices.
However, open-loop testing is not sufficient nor effective in finding safety violations which involve complex and/or lengthy interactions between the device and the heart.
That's because it is not possible to think ahead of all possible interaction sequences, nor is it feasible to generate all possible input sequences to the pacemaker.
Thus the Physiological Requirements should be verified with closed-loop testing where the device is tested within its physiological context of a heart or appropriate heart model. 
Today, the Physiological Requirements are mostly verified by \emph{clinical trials} in which the devices are implanted in a select group of patients and monitored over a certain period of time. 
The limitations of clinical trials are extremely high cost and limited sample size of patient groups.

Model-based design enables closed-loop verification at an earlier design stage. 
The device (or corresponding software or even a mathematical model) interacts with a simulation model of the heart.
The latter can simulate signals into the device and respond to device outputs. 

\textbf{Contributions}. 
In this paper, we propose the use of a Virtual Heart Model (VHM) for closed-loop testing of pacemakers.
The testing setup can be applied to testing actual devices, or software models of them.
In addition, we propose the use of an automatic test generation algorithm which uses the Specifications and Requirements as a guide for generating the tests.
The tester is guaranteed to find faulty behavior if it exists, under suitable conditions. 
We demonstrate that using this setup, we can find unsafe or undesirable heart conditions that can not be found in open-loop testing.

