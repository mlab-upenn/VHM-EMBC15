\section{Closed-loop Testing of Pacemaker}
\label{closedloop}

= SS: Closed-loop.
Table comparing closed-loop with open-loop.
Robustness-guided testing.
%\input{openloop}

\textbf{Controlled inputs}.
In our setup, the testing algorithm will generate PVC waveforms to mimic the abnormal depolarizations of the ventricles that occur in a heart with arrythmia. 
A \emph{test} is then defined as a PVC waveform of a pre-determined duration $T$ ms.
These are used by the tester to try and cause the closed loop to manifest unsafe or undesirable heart conditions.
The constraint on the waveforms generated by the tester is that there should be at least 400ms between consecutive PVC impulses.

\textbf{Closed-loop setup}.
The closed-loop setup is the same as the setup for live operation shown in Fig.~\ref{fig:liveSetup}, with the addition of the tester at the PVC inputs to the heart.
That is, the pacemaker is connected to the heart model, and the inputs to the pacemaker are provided by the VHMeart model, and don't need to be pre-programmed by the validator. 
The tester controls the external PVC disturbances, which thus also don't need to be pre-programmed by the validator.
This setup is shown in Fig.~\ref{fig:reqGuidedTesting}.

\textbf{The tester}.
The tester itself is a specification-guided test generation algorithm, whose theory can be reviewed in \cite{AbbasFSIG13tecs}.
The testing algorithm has been implemented in the tool S-Taliro \cite{AnnapureddyLFS11tacas}, and has been used in other medical applications like the analysis of insulin infusion pumps schedules \cite{SankaranarayananF2012cmsb}.
Briefly, we provide S-Taliro with a specification that the pacemaker+heart system must satisfy,
e.g., ``there should be a minimum delay of 500ms between VP events''.
S-Taliro then generates a sequence of tests, i.e., a sequence of PVC waveforms, each of a pre-determined duration $T$ ms.
After each test, S-Taliro observes the outputs from the system and calculates \emph{the degree} to which the specification is satisfied or not.
This degree is then used to choose the next test to apply. 
It can be shown that if the system can exhibit a behavior that violates the specification, then this iterative process converges to a test that will produce this incorrect behavior \cite{AbbasF_HybridSA12}. 
This test then serves as evidence that the pacemaker+heart loop can exhibit undesired behavior that violates the specification.
The pacemaker's designer can then replay this test to see where things went wrong, and whether the pacemaker needs to be adjusted accordingly.

\textbf{Advantages over open-loop testing}.
The advantages of the proposed specification-guided closed-loop testing approach over directed open-loop testing are summarized in Table \ref{table:CLoverOL}, and discussed here:
\begin{table*}
	\centering
	\begin{tabular}{|l|l|l|}
	\hline                       & Open-Loop    & Specification-Guided Closed-Loop 
	\\ 
	\hline Choice of pacemaker input traces  
	                & Manual and recorded traces. Might miss interesting behavior, &  Automatic and provided by the VHM,
	\\ 
					& or include irrelevant behavior. &  so only relevant input traces are used.
	\\
	\hline Criterion of correctness    & Only pacemaker behavior & The heart and pacemakers's joint behavior, so 
	\\
	                &                  & physiological effects of pacemaker actions
	\\
	                &                  &  can be used to determine correctness.                   
	\\ 
	\hline Choice of tests & Tests = input traces to pacemaker.  & Testing traces = traces of external disturbances, 
	\\
	                & Manually chosen.  & like PVC and PAC. Automatically selected.
	\\
	\hline 
\end{tabular}
\label{table:CLoverOL}
\end{table*}

\begin{itemize}
	\item Choice of inputs: because a heart model provides the input traces to the pacemaker, we know that only relevant test cases will be generated and fed to the pacemaker. 
	That is, only traces that the pacemaker may actually see during live operation are fed to it during testing. 
	\footnote{Of course, this ultimately depends on the quality of the VHM.}
	Moreover, because the tester searches the space of tests systematically, we are guaranteed to find violating behavior if it exists.
	\item Criterion of correctness: because we have a VHM, we can express correctness \emph{as a property of the heart's behavior}, and not of the pacemaker alone. 
	Thus we can evaluate what truly matters: is the heart (as modeled by the VHM) displaying unsafe or undesirable behavior?
\end{itemize}


%\textbf{Choice of specifications to test}.
%Because the heart's behavior is complex and varies depending on its physiological structure and history, it is not always easy to describe succinctly what is `unsafe' and what is `undesirable'.
%Both categories vary depending on what we know (and what we discover) about the heart conditions being modeled.

\textbf{Interpretation of testing results}.
It must be stressed that the interpretation of closed-loop testing results depends on the specific violating behaviors that are found.
Some will be determined to be bugs. 
Others will be determined to be undesirable but necessary behaviors, and we show such a case in Section \ref{experiments}.
This is because specifying `safe' behavior can be difficult for something as complex as the heart.
